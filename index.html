<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Combinatorics Practice - Created by Mr. McLean Math</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    --bg: #050816;
    --card: #0b1024;
    --accent: #3b82f6;
    --accent-soft: #1e293b;
    --accent-easy: #22c55e;
    --accent-med: #eab308;
    --accent-hard: #ef4444;
    --text: #e5e7eb;
    --muted: #9ca3af;
    --border: #1f2937;
    --danger: #f97373;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: radial-gradient(circle at top, #1f2933 0, #020617 52%, #000 100%);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 1rem;
  }

  .app {
    width: 100%;
    max-width: 1100px;
    background: rgba(5, 10, 25, 0.96);
    border-radius: 1.25rem;
    border: 1px solid var(--border);
    box-shadow: 0 25px 80px rgba(0,0,0,0.7);
    padding: 1.25rem 1.5rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  header {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem 1.5rem;
    align-items: baseline;
    justify-content: space-between;
  }

  header h1 {
    font-size: 1.4rem;
    margin: 0;
  }

  header .subtitle {
    font-size: 0.9rem;
    color: var(--muted);
  }

  .top-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: stretch;
  }

  .left-column {
    flex: 2 1 260px;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .right-column {
    flex: 1.4 1 220px;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .card {
    background: var(--card);
    border-radius: 0.9rem;
    border: 1px solid var(--border);
    padding: 0.8rem 0.9rem;
  }

  .card h2 {
    margin: 0 0 0.5rem;
    font-size: 1rem;
  }

  .mode-toggle {
    display: inline-flex;
    border-radius: 999px;
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .mode-btn {
    position: relative;
    padding: 0.3rem 0.8rem;
    font-size: 0.85rem;
    border: none;
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    flex: 1 1 0;
  }

  .mode-btn.active {
    background: var(--accent-soft);
    color: var(--text);
  }

  .difficulty-row, .controls-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
    justify-content: space-between;
  }

  .difficulty-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .diff-btn {
    border-radius: 999px;
    border: 1px solid var(--border);
    padding: 0.2rem 0.7rem;
    font-size: 0.85rem;
    background: #020617;
    color: var(--muted);
    cursor: pointer;
  }

  .diff-btn span.emoji {
    margin-right: 0.25rem;
  }

  .diff-btn.easy.active { background: rgba(34,197,94,0.2); color: var(--text); border-color: var(--accent-easy); }
  .diff-btn.med.active { background: rgba(234,179,8,0.2); color: var(--text); border-color: var(--accent-med); }
  .diff-btn.hard.active { background: rgba(239,68,68,0.2); color: var(--text); border-color: var(--accent-hard); }
  .diff-btn.random.active { background: rgba(59,130,246,0.25); color: var(--text); border-color: var(--accent); }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    border-radius: 999px;
    padding: 0.1rem 0.5rem;
    font-size: 0.7rem;
    border: 1px solid var(--border);
    color: var(--muted);
  }

  .badge-dot {
    width: 0.4rem;
    height: 0.4rem;
    border-radius: 999px;
    background: var(--accent);
  }

  .question-text {
    font-size: 1rem;
    margin-bottom: 0.6rem;
    line-height: 1.4;
  }

  .input-row {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .answer-input {
    flex: 1 1 150px;
    padding: 0.45rem 0.55rem;
    border-radius: 0.6rem;
    border: 1px solid var(--border);
    font-size: 1rem;
    background: #020617;
    color: var(--text);
  }

  .answer-input:focus {
    outline: 2px solid var(--accent);
    outline-offset: 1px;
  }

  .btn {
    padding: 0.4rem 0.9rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #020617;
    color: var(--text);
    font-size: 0.9rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .btn-secondary {
    background: #020617;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: default;
  }

  .feedback {
    margin-top: 0.4rem;
    min-height: 2.5rem;
    font-size: 0.9rem;
  }

  .feedback-line {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-items: baseline;
  }

  .feedback-status {
    font-weight: 600;
  }

  .feedback-status.correct {
    color: var(--accent-easy);
  }

  .feedback-status.incorrect {
    color: var(--danger);
  }

  .explanation {
    margin-top: 0.25rem;
    font-size: 0.86rem;
    color: var(--muted);
  }

  .toggle-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-items: center;
    justify-content: space-between;
  }

  .toggle-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-items: center;
  }

  .switch-label {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.8rem;
    color: var(--muted);
    cursor: pointer;
  }

  .switch {
    position: relative;
    width: 32px;
    height: 18px;
    border-radius: 999px;
    background: #111827;
    border: 1px solid var(--border);
    flex-shrink: 0;
  }

  .switch-thumb {
    position: absolute;
    top: 1px;
    left: 1px;
    width: 14px;
    height: 14px;
    border-radius: 999px;
    background: #6b7280;
    transition: transform 0.15s ease, background 0.15s ease;
  }

  .switch.on {
    background: #1d4ed8;
  }

  .switch.on .switch-thumb {
    transform: translateX(12px);
    background: white;
  }

  .timer-select {
    font-size: 0.8rem;
    padding: 0.18rem 0.6rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #020617;
    color: var(--muted);
  }

  .timer-display {
    font-size: 0.9rem;
    font-variant-numeric: tabular-nums;
  }

  .timer-display.danger {
    color: var(--danger);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(110px,1fr));
    gap: 0.4rem;
  }

  .stat-box {
    border-radius: 0.6rem;
    padding: 0.4rem 0.5rem;
    background: #020617;
    border: 1px solid var(--border);
    font-size: 0.75rem;
  }

  .stat-label {
    color: var(--muted);
    margin-bottom: 0.1rem;
  }

  .stat-value {
    font-size: 1rem;
    font-variant-numeric: tabular-nums;
  }

  .summary-list {
    margin-top: 0.4rem;
    max-height: 200px;
    overflow: auto;
    font-size: 0.8rem;
  }

  .summary-item {
    border-top: 1px solid var(--border);
    padding: 0.3rem 0.1rem;
  }

  .summary-item strong {
    font-weight: 600;
  }

  .worksheet-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    align-items: center;
    margin-bottom: 0.6rem;
  }

  .worksheet-controls-section {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    align-items: center;
    font-size: 0.8rem;
    color: var(--muted);
  }

  .worksheet-select {
    padding: 0.18rem 0.5rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #020617;
    color: var(--muted);
    font-size: 0.8rem;
  }

  .worksheet-header {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 0.4rem;
  }

  .worksheet-list {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    max-height: 320px;
    overflow: auto;
  }

  .worksheet-item {
    border-radius: 0.6rem;
    padding: 0.35rem 0.45rem;
    border: 1px solid var(--border);
    background: #020617;
    font-size: 0.86rem;
  }

  .worksheet-q {
    margin-bottom: 0.2rem;
  }

  .worksheet-answer {
    color: var(--muted);
    margin-top: 0.1rem;
  }

  .worksheet-answer.hidden {
    display: none;
  }

  .dev-panel {
    margin-top: 0.6rem;
    font-size: 0.8rem;
    border-radius: 0.6rem;
    padding: 0.4rem 0.5rem;
    background: #111827;
    border: 1px dashed var(--accent);
  }

  .dev-panel h3 {
    margin: 0 0 0.3rem;
    font-size: 0.9rem;
  }

  .dev-test {
    display: flex;
    justify-content: space-between;
    gap: 0.4rem;
    padding: 0.1rem 0;
  }

  .dev-test span.status-pass {
    color: var(--accent-easy);
  }

  .dev-test span.status-fail {
    color: var(--danger);
  }

  footer {
    margin-top: 0.4rem;
    font-size: 0.75rem;
    color: var(--muted);
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.3rem;
  }

  @media (max-width: 768px) {
    .app {
      padding: 1rem;
    }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>Combinatorics Practice</h1>
      <div class="subtitle">Year 8 - permutations, combinations and simple probability</div>
    </div>
    <div class="mode-toggle" aria-label="Select mode">
      <button class="mode-btn active" id="modeGameBtn" type="button">Game mode</button>
      <button class="mode-btn" id="modeWorksheetBtn" type="button">Worksheet mode</button>
    </div>
  </header>

  <div class="top-row">
    <div class="left-column">
      <section class="card" id="gameCard" aria-label="Game mode">
        <div class="difficulty-row">
          <div class="difficulty-buttons" aria-label="Difficulty">
            <button class="diff-btn easy active" data-diff="easy" type="button">
              <span class="emoji">游릭</span> Easy
            </button>
            <button class="diff-btn med" data-diff="medium" type="button">
              <span class="emoji">游리</span> Medium
            </button>
            <button class="diff-btn hard" data-diff="hard" type="button">
              <span class="emoji">游댮</span> Hard
            </button>
            <button class="diff-btn random" data-diff="random" type="button">
              <span class="emoji">游</span> Random
            </button>
          </div>
          <div class="badge">
            <span class="badge-dot"></span>
            <span>Enter = Submit / Next</span>
          </div>
        </div>

        <div class="question-area" aria-live="polite">
          <p class="question-text" id="questionText">
            Loading first question...
          </p>
        </div>

        <div class="input-row">
          <input id="answerInput" class="answer-input" autocomplete="off" />
          <button id="submitBtn" class="btn btn-primary" type="button">
            Submit
          </button>
          <button id="nextBtn" class="btn btn-secondary" type="button">
            Next
          </button>
        </div>

        <div class="feedback" id="feedbackArea"></div>
      </section>

      <section class="card" id="worksheetCard" aria-label="Worksheet mode" style="display:none;">
        <h2>Worksheet generator</h2>
        <div class="worksheet-controls">
          <div class="worksheet-controls-section">
            <span>Difficulty:</span>
            <select id="wsDifficulty" class="worksheet-select">
              <option value="easy">游릭 Easy</option>
              <option value="medium">游리 Medium</option>
              <option value="hard">游댮 Hard</option>
              <option value="random">游 Random mix</option>
            </select>
          </div>
          <div class="worksheet-controls-section">
            <span>Number of questions:</span>
            <select id="wsCount" class="worksheet-select">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="15">15</option>
            </select>
          </div>
          <button id="generateWorksheetBtn" class="btn btn-primary" type="button">
            Generate worksheet
          </button>
          <button id="revealAllBtn" class="btn btn-secondary" type="button">
            Reveal all
          </button>
          <button id="hideAllBtn" class="btn btn-secondary" type="button">
            Hide all
          </button>
        </div>
        <div class="worksheet-header">
          Instruction: Answer each question. Then check your work using the answer key.
        </div>
        <div id="worksheetList" class="worksheet-list" aria-live="polite"></div>
      </section>
    </div>

    <div class="right-column">
      <section class="card">
        <h2>Controls</h2>
        <div class="toggle-row">
          <div class="toggle-group">
            <label class="switch-label">
              <div id="timerSwitch" class="switch" role="switch" aria-checked="false" tabindex="0">
                <div class="switch-thumb"></div>
              </div>
              Timer
            </label>
            <select id="timerSelect" class="timer-select" aria-label="Timer length">
              <option value="0">Off</option>
              <option value="30">30 s</option>
              <option value="60" selected>60 s</option>
              <option value="90">90 s</option>
              <option value="120">120 s</option>
            </select>
          </div>
          <div class="toggle-group">
            <label class="switch-label">
              <div id="soundSwitch" class="switch on" role="switch" aria-checked="true" tabindex="0">
                <div class="switch-thumb"></div>
              </div>
              Sound
            </label>
          </div>
        </div>
        <div style="margin-top:0.45rem; display:flex; justify-content:space-between; align-items:center;">
          <div class="timer-display" id="timerDisplay">Timer off</div>
          <button id="resetSessionBtn" class="btn btn-secondary" type="button">Reset session</button>
        </div>
      </section>

      <section class="card">
        <h2>Session summary</h2>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">Total answered</div>
            <div class="stat-value" id="statTotal">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Correct</div>
            <div class="stat-value" id="statCorrect">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Accuracy</div>
            <div class="stat-value" id="statAccuracy">0%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Score</div>
            <div class="stat-value" id="statScore">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Current streak</div>
            <div class="stat-value" id="statStreak">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Best streak</div>
            <div class="stat-value" id="statBestStreak">0</div>
          </div>
        </div>
        <div class="summary-list" id="summaryList" aria-label="Incorrect answers list"></div>
      </section>

      <section class="card" id="devPanel" style="display:none;">
        <h3>Developer tests (?dev=1)</h3>
        <div id="devTestsContainer"></div>
      </section>
    </div>
  </div>

  <footer>
    <div>Created by Mr. McLean Math.</div>
    <div>Use Enter to submit; on a correct answer, press Enter or Next to go on.</div>
  </footer>
</div>

<script>
(function() {
  "use strict";

  // ---------- Utility functions ----------

  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function choose(arr) {
    return arr[randInt(0, arr.length - 1)];
  }

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const tmp = a[i];
      a[i] = a[j];
      a[j] = tmp;
    }
    return a;
  }

  function factorial(n) {
    let r = 1;
    for (let i = 2; i <= n; i++) r *= i;
    return r;
  }

  function combinations(n, k) {
    if (k < 0 || k > n) return 0;
    if (k === 0 || k === n) return 1;
    k = Math.min(k, n - k);
    let num = 1;
    let den = 1;
    for (let i = 1; i <= k; i++) {
      num *= (n - (k - i));
      den *= i;
    }
    return num / den;
  }

  function gcd(a, b) {
    a = Math.abs(a);
    b = Math.abs(b);
    while (b) {
      const t = b;
      b = a % b;
      a = t;
    }
    return a || 1;
  }

  function simplifyFraction(num, den) {
    if (den < 0) {
      num = -num;
      den = -den;
    }
    const g = gcd(num, den);
    return { num: num / g, den: den / g };
  }

  function formatNumberWithSpaces(value) {
    if (typeof value !== "number" || !isFinite(value)) return String(value);
    const isInt = Math.abs(value - Math.round(value)) < 1e-9;
    let s;
    if (isInt) {
      s = String(Math.round(value));
    } else {
      s = value.toString();
    }
    const parts = s.split(".");
    let intPart = parts[0];
    const neg = intPart[0] === "-";
    if (neg) intPart = intPart.slice(1);
    let out = "";
    while (intPart.length > 3) {
      const chunk = intPart.slice(-3);
      out = " " + chunk + out;
      intPart = intPart.slice(0, -3);
    }
    out = intPart + out;
    if (neg) out = "-" + out;
    if (parts.length > 1) return out + "." + parts[1];
    return out;
  }

  function parseIntegerInput(raw) {
    let s = (raw || "").trim().replace(/\s+/g, "");
    if (s === "") return null;
    s = s.replace(",", ".");
    const value = Number(s);
    if (!isFinite(value)) return null;
    if (Math.abs(value - Math.round(value)) > 1e-9) return null;
    return Math.round(value);
  }

  function parseRationalInput(raw) {
    let s = (raw || "").trim();
    if (s === "") return null;

    if (s.includes("/")) {
      const parts = s.split("/");
      if (parts.length !== 2) return null;
      let num = parseInt(parts[0].replace(/\s+/g, ""), 10);
      let den = parseInt(parts[1].replace(/\s+/g, ""), 10);
      if (!isFinite(num) || !isFinite(den) || den === 0) return null;
      return simplifyFraction(num, den);
    }

    s = s.replace(/\s+/g, "");
    s = s.replace(",", ".");
    const v = Number(s);
    if (!isFinite(v)) return null;

    const str = v.toString();
    const decIndex = str.indexOf(".");
    if (decIndex === -1) return simplifyFraction(v, 1);

    const decimals = str.length - decIndex - 1;
    const den = Math.pow(10, decimals);
    const num = Math.round(v * den);
    return simplifyFraction(num, den);
  }

  function equalRationals(a, b) {
    return a && b && a.num === b.num && a.den === b.den;
  }

  function rationalToString(fr) {
    if (!fr) return "";
    if (fr.den === 1) return formatNumberWithSpaces(fr.num);
    return fr.num + "/" + fr.den;
  }

  // ---------- Anti-repeat system ----------
  // Keeps recent question "keys" so the game doesn't feel repetitive.
  const RECENT_LIMIT = 18;
  const recentKeys = [];

  function makeKey(q) {
    // Key based on question text + answer type + answer value
    let ans = "";
    if (q.answerType === "integer") ans = "i:" + String(q.correctInteger);
    else ans = "r:" + q.correctRational.num + "/" + q.correctRational.den;
    return q.text + "||" + q.answerType + "||" + ans;
  }

  function rememberKey(key) {
    recentKeys.push(key);
    while (recentKeys.length > RECENT_LIMIT) recentKeys.shift();
  }

  function isRecent(key) {
    return recentKeys.indexOf(key) !== -1;
  }

  function generateNonRepeating(difficulty) {
    // Try a bunch of times to avoid repeats
    for (let tries = 0; tries < 50; tries++) {
      const q = generateQuestionRaw(difficulty);
      const k = makeKey(q);
      if (!isRecent(k)) {
        rememberKey(k);
        return q;
      }
    }
    // If we somehow can't find a non-repeat, just take one
    const fallback = generateQuestionRaw(difficulty);
    rememberKey(makeKey(fallback));
    return fallback;
  }

  // ---------- Question generator ----------
  // Question format:
  // {
  //   text: string,
  //   answerType: "integer" | "rational",
  //   correctInteger: number (if integer),
  //   correctRational: {num, den} (if rational),
  //   explanation: string
  // }

  function genEasyQuestion() {
    const type = randInt(1, 10);
    switch (type) {
      case 1: {
        // Existing: Two-digit numbers from 3 distinct digits, no repetition
        const digitsPool = shuffle([2,3,4,5,6,7,8,9]);
        const digits = digitsPool.slice(0, 3).sort();
        const n = digits.length;
        const count = n * (n - 1);
        const text = "You have the digits " + digits.join(", ") +
          ". How many different two-digit numbers can you form if each digit may be used at most once in each number?";
        const explanation = "First digit: " + n + " choices. Second digit: " + (n - 1) +
          " choices. Total: " + n + " x " + (n - 1) + " = " + count + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 2: {
        // Existing: 3-digit code 0-9 repetition allowed
        const length = 3;
        const count = Math.pow(10, length);
        const text = "A code lock uses a " + length +
          "-digit code. Each digit can be any of the digits 0-9 and digits may repeat. How many different codes are possible?";
        const explanation = "Each position has 10 choices. Total: 10^" + length + " = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 3: {
        // Existing: shirts and jeans
        const shirts = randInt(3, 6);
        const jeans = randInt(2, 5);
        const count = shirts * jeans;
        const text = "Emil has " + shirts + " different shirts and " + jeans +
          " pairs of jeans. Each day he wears one shirt and one pair of jeans. In how many different ways can he combine his clothes?";
        const explanation = shirts + " choices for shirts and " + jeans + " choices for jeans. Total: " + shirts + " x " + jeans + " = " + count + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 4: {
        // Existing: 3 students line
        const namesPool = ["Anna", "Bilal", "Carla", "David", "Elias", "Fatima", "Hugo", "Iman"];
        const names = shuffle(namesPool).slice(0, 3);
        const n = names.length;
        const count = factorial(n);
        const text = names.join(", ") +
          " are standing in a line to present their project. In how many different orders can they stand in the line?";
        const explanation = "3 positions: 3 x 2 x 1 = 6.";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 5: {
        // Existing: quiz 1/X/2
        const q = randInt(3, 6);
        const count = Math.pow(3, q);
        const text = "On a small quiz there are " + q +
          " questions. For each question you answer 1, X or 2. In how many different ways can you answer the whole quiz?";
        const explanation = "Each question has 3 choices. Total: 3^" + q + " = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 6: {
        // NEW: Ice cream flavours + toppings
        const flavours = randInt(3, 6);
        const toppings = randInt(2, 5);
        const count = flavours * toppings;
        const text = "At an ice cream shop you choose 1 flavour out of " + flavours +
          " and 1 topping out of " + toppings + ". How many different ice creams can you make?";
        const explanation = flavours + " x " + toppings + " = " + count + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 7: {
        // NEW: PIN of length 2-4, digits 0-9 repetition allowed
        const length = randInt(2, 4);
        const count = Math.pow(10, length);
        const text = "A PIN code has " + length + " digits. Digits can be 0-9 and may repeat. How many PIN codes are possible?";
        const explanation = "10 choices per digit. Total: 10^" + length + " = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 8: {
        // NEW: Arrange 4 students (simple permutation)
        const namesPool = ["Omar", "Sara", "Lina", "Noah", "Maja", "Alex", "Yusuf", "Lea"];
        const k = 4;
        const names = shuffle(namesPool).slice(0, k);
        const count = factorial(k);
        const text = names.join(", ") + " are standing in a line. How many different orders can they stand in?";
        const explanation = "Permutations of 4 distinct people: 4! = 24.";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 9: {
        // NEW: Choose 1 drink and 1 snack (rule of product)
        const drinks = randInt(3, 6);
        const snacks = randInt(3, 6);
        const count = drinks * snacks;
        const text = "In a cafe there are " + drinks + " drinks and " + snacks + " snacks. You choose one drink and one snack. How many choices are there?";
        const explanation = drinks + " x " + snacks + " = " + count + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 10: {
        // NEW: Two-letter code from 6 letters, repetition allowed
        const letters = ["A","B","C","D","E","F"];
        const count = letters.length * letters.length;
        const text = "You make a two-letter code using the letters A, B, C, D, E, F. Letters may repeat. How many codes are possible?";
        const explanation = "6 choices for the first letter and 6 for the second: 6 x 6 = 36.";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      default:
        return genEasyQuestion();
    }
  }

  function genMediumQuestion() {
    const type = randInt(1, 14);
    switch (type) {
      case 1: {
        // Existing: 4-digit number with first digit fixed, no repetition
        const digitsPool = shuffle([1,2,3,4,5,6,7,8,9]);
        const fixed = digitsPool[0];
        const rest = digitsPool.slice(1, 6);
        const nRest = rest.length;
        const count = nRest * (nRest - 1) * (nRest - 2);
        const text = "You have the digits " + [fixed].concat(rest).join(", ") +
          ". You want to form four-digit numbers where the first digit must be " + fixed +
          " and no digit may be used more than once in a number. How many such numbers are possible?";
        const explanation = "First digit fixed. Then: " + nRest + " x " + (nRest - 1) + " x " + (nRest - 2) + " = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 2: {
        // Existing: last digit odd, no repetition (avoid 0)
        const digits = shuffle([1,2,3,4,5,6,7,8,9]).slice(0, 6);
        const odds = digits.filter(d => d % 2 !== 0);
        const nOdds = odds.length;
        const nDigits = digits.length;
        const count = nOdds * (nDigits - 1) * (nDigits - 2) * (nDigits - 3);
        const text = "Using the digits " + digits.join(", ") +
          " you form four-digit numbers where no digit repeats and the last digit must be odd. How many such numbers can you form?";
        const explanation = "Choose odd last digit (" + nOdds + "). Then remaining slots: " +
          (nDigits - 1) + " x " + (nDigits - 2) + " x " + (nDigits - 3) +
          ". Total: " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 3: {
        // Existing: 4-digit code repetition allowed
        const length = 4;
        const count = Math.pow(10, length);
        const text = "A security code consists of " + length +
          " digits. Each digit can be any of the digits 0-9 and digits may repeat. How many different codes can be made?";
        const explanation = "10^" + length + " = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 4: {
        // Existing: starter-main-dessert
        const starters = randInt(2, 5);
        const mains = randInt(3, 6);
        const desserts = randInt(2, 4);
        const count = starters * mains * desserts;
        const text = "At a restaurant you can choose between " + starters +
          " starters, " + mains + " main courses and " + desserts +
          " desserts. You order one starter, one main course and one dessert. In how many different ways can you choose your meal?";
        const explanation = starters + " x " + mains + " x " + desserts + " = " + count + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 5: {
        // Existing: A,B,C,D with/without repetition
        const letters = ["A","B","C","D"];
        const length = 4;
        const allowRepeat = Math.random() < 0.5;
        let count, text, explanation;
        if (allowRepeat) {
          count = Math.pow(letters.length, length);
          text = "You make codes that are " + length +
            " letters long using the letters A, B, C and D. Letters may repeat. How many different codes are possible?";
          explanation = "4^" + length + " = " + count + ".";
        } else {
          count = factorial(letters.length);
          text = "You arrange the letters A, B, C and D to form letter codes that are " +
            length + " letters long. Each letter must be used exactly once. How many different codes are possible?";
          explanation = "4! = " + count + ".";
        }
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 6: {
        // Existing: probability red
        const red = randInt(2, 6);
        const blue = randInt(2, 6);
        const green = randInt(1, 5);
        const total = red + blue + green;
        const fr = simplifyFraction(red, total);
        const text = "In a bag there are " + red + " red marbles, " + blue +
          " blue marbles and " + green +
          " green marbles. One marble is drawn at random. What is the probability that it is red?";
        const explanation = "Probability = red/total = " + red + "/" + total + " = " + rationalToString(fr) + ".";
        return { text, answerType: "rational", correctRational: fr, explanation };
      }

      // NEW medium variety below:

      case 7: {
        // Choose 2 toppings from n (combinations)
        const n = randInt(6, 10);
        const k = 2;
        const count = combinations(n, k);
        const text = "A pizza place has " + n + " different toppings. You choose exactly " + k + " different toppings. How many different topping combinations are possible?";
        const explanation = "Order does not matter: C(" + n + "," + k + ") = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 8: {
        // Choose 3 from n
        const n = randInt(7, 12);
        const k = 3;
        const count = combinations(n, k);
        const text = "A class has " + n + " students. A team of " + k + " students must be chosen. How many different teams are possible?";
        const explanation = "Order does not matter: C(" + n + "," + k + ") = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 9: {
        // Permutations: arrange k out of n
        const n = randInt(6, 9);
        const k = randInt(3, 5);
        let count = 1;
        for (let i = 0; i < k; i++) count *= (n - i);
        const text = "There are " + n + " books. You choose " + k + " different books and place them on a shelf in a row. How many different ordered arrangements are possible?";
        const explanation = "Order matters: " + n + "P" + k + " = " + n + " x " + (n-1) + " x ... (" + k + " factors) = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 10: {
        // Probability NOT red
        const red = randInt(2, 7);
        const blue = randInt(2, 7);
        const green = randInt(1, 6);
        const total = red + blue + green;
        const nonRed = total - red;
        const fr = simplifyFraction(nonRed, total);
        const text = "In a bag there are " + red + " red balls, " + blue + " blue balls and " + green + " green balls. One ball is drawn at random. What is the probability that it is NOT red?";
        const explanation = "Not red means blue or green: (" + blue + " + " + green + ")/" + total + " = " + nonRed + "/" + total + " = " + rationalToString(fr) + ".";
        return { text, answerType: "rational", correctRational: fr, explanation };
      }
      case 11: {
        // Two-stage outfit with shoes too
        const shirts = randInt(3, 6);
        const pants = randInt(2, 5);
        const shoes = randInt(2, 4);
        const count = shirts * pants * shoes;
        const text = "Emil has " + shirts + " shirts, " + pants + " pairs of pants and " + shoes + " pairs of shoes. He chooses 1 of each. How many outfits are possible?";
        const explanation = shirts + " x " + pants + " x " + shoes + " = " + count + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 12: {
        // 5-digit code, digits 0-9, repetition allowed
        const length = 5;
        const count = Math.pow(10, length);
        const text = "A code consists of " + length + " digits (0-9). Digits may repeat. How many codes are possible?";
        const explanation = "10^" + length + " = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 13: {
        // Password letters only: 26 letters, length 4
        const letters = 26;
        const length = 4;
        const count = Math.pow(letters, length);
        const text = "A password uses only lowercase English letters (26 letters). The password length is " + length + " and letters may repeat. How many passwords are possible?";
        const explanation = "26^" + length + " = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 14: {
        // Combinations with a story: choose 2 desserts from n
        const n = randInt(5, 9);
        const k = 2;
        const count = combinations(n, k);
        const text = "A bakery has " + n + " different desserts. You choose " + k + " different desserts to share. How many different choices are possible?";
        const explanation = "Order does not matter: C(" + n + "," + k + ") = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      default:
        return genMediumQuestion();
    }
  }

  function genHardQuestion() {
    const type = randInt(1, 14);
    switch (type) {
      case 1: {
        // Existing: permutations of 1,3,5,7,9
        const digits = [1,3,5,7,9];
        const count = factorial(digits.length);
        const text = "You make five-digit numbers using each of the digits 1, 3, 5, 7 and 9 exactly once in each number. How many different numbers can you make?";
        const explanation = "5 distinct digits arranged: 5! = 120.";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 2: {
        // Existing: 3 letters from Swedish alphabet (29), repetition allowed
        const letters = 29;
        const length = 3;
        const count = Math.pow(letters, length);
        const text = "A company creates codes that consist of " + length +
          " letters from the Swedish alphabet. Letters may repeat. The Swedish alphabet has 29 letters. How many different letter codes are possible?";
        const explanation = "29^" + length + " = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 3: {
        // Existing: license plates 3 letters + 3 digits
        const letters = 29;
        const digits = 10;
        const count = Math.pow(letters, 3) * Math.pow(digits, 3);
        const text = "A type of licence plate has three letters followed by three digits. The letters come from the Swedish alphabet with 29 letters, and the digits are 0-9. How many different licence plates of this type are possible?";
        const explanation = "29^3 choices for letters and 10^3 for digits. Total: 29^3 x 10^3 = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 4: {
        // Existing: betting form 1/X/2
        const q = randInt(8, 14);
        const count = Math.pow(3, q);
        const text = "On a betting form there are " + q +
          " matches. For each match you can choose 1, X or 2. In how many different ways can you fill in the whole form?";
        const explanation = "3^" + q + " = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 5: {
        // Existing: probability neither red nor green
        const red = randInt(3, 7);
        const green = randInt(2, 6);
        const other = randInt(2, 8);
        const total = red + green + other;
        const fr = simplifyFraction(other, total);
        const text = "A bag contains " + red + " red balls, " + green +
          " green balls and " + other +
          " balls of other colours. One ball is drawn at random. What is the probability that the ball is neither red nor green?";
        const explanation = "Favourable = other colours: " + other + "/" + total + " = " + rationalToString(fr) + ".";
        return { text, answerType: "rational", correctRational: fr, explanation };
      }
      case 6: {
        // Existing: handshakes
        const n = randInt(10, 25);
        const count = n * (n - 1) / 2;
        const text = n + " people meet at a conference. Each pair of people shakes hands exactly once. How many handshakes are there in total?";
        const explanation = "Number of pairs: n(n - 1)/2. " + n + " x " + (n - 1) + " / 2 = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 7: {
        // Existing: time to try all codes, rounded hours
        const length = 4;
        const countCodes = Math.pow(10, length);
        const secondsPer = 10;
        const totalSeconds = countCodes * secondsPer;
        const totalHours = totalSeconds / 3600;
        const roundedHours = Math.round(totalHours);
        const text = "A door code consists of " + length +
          " digits, each from 0-9. All " + formatNumberWithSpaces(countCodes) +
          " codes are equally possible. Someone tries the codes one by one without repeating, and each try takes about " +
          secondsPer + " seconds. About how many hours would it take to try all codes? Give your answer rounded to the nearest whole hour.";
        const explanation = formatNumberWithSpaces(countCodes) + " tries x " + secondsPer + " s = " +
          formatNumberWithSpaces(totalSeconds) + " s. Hours = " + totalSeconds + "/3600 = " + totalHours.toFixed(2) +
          ", rounds to " + formatNumberWithSpaces(roundedHours) + ".";
        return { text, answerType: "integer", correctInteger: roundedHours, explanation };
      }

      // NEW hard variety below:

      case 8: {
        // Combinations: choose 4 from n (bigger)
        const n = randInt(10, 16);
        const k = 4;
        const count = combinations(n, k);
        const text = "A sports club has " + n + " members. A committee of " + k + " people is chosen. How many different committees are possible?";
        const explanation = "Order does not matter: C(" + n + "," + k + ") = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 9: {
        // Permutations with restrictions: 5-digit from digits, no repetition, must start with an odd digit
        const digits = shuffle([1,2,3,4,5,6,7,8,9]).slice(0, 7);
        const odds = digits.filter(d => d % 2 !== 0);
        if (odds.length < 2) return genHardQuestion();

        // Form 5-digit numbers from these digits, no repeat, first digit must be odd.
        // Choose first digit among odds, then choose 4 remaining digits in order from remaining pool.
        const firstChoices = odds.length;
        const remaining = digits.length - 1;
        let tailWays = 1;
        for (let i = 0; i < 4; i++) tailWays *= (remaining - i);
        const count = firstChoices * tailWays;

        const text = "Using the digits " + digits.join(", ") + ", you form five-digit numbers with no repeated digits. The first digit must be odd. How many such numbers are possible?";
        const explanation = "Choose an odd first digit (" + firstChoices + " ways). Then arrange 4 of the remaining " + remaining +
          " digits: " + remaining + " x " + (remaining-1) + " x " + (remaining-2) + " x " + (remaining-3) +
          ". Total: " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 10: {
        // Probability: pick blue or green
        const red = randInt(3, 8);
        const blue = randInt(3, 8);
        const green = randInt(3, 8);
        const total = red + blue + green;
        const fav = blue + green;
        const fr = simplifyFraction(fav, total);
        const text = "A bag contains " + red + " red marbles, " + blue + " blue marbles, and " + green + " green marbles. One marble is drawn at random. What is the probability that it is blue or green?";
        const explanation = "Favourable outcomes = " + blue + " + " + green + " = " + fav + ". Probability = " + fav + "/" + total + " = " + rationalToString(fr) + ".";
        return { text, answerType: "rational", correctRational: fr, explanation };
      }
      case 11: {
        // Counting rectangles on a grid (simple formula)
        const a = randInt(2, 5);
        const b = randInt(2, 6);
        // rectangles in axb grid: a(a+1)/2 * b(b+1)/2
        const count = (a * (a + 1) / 2) * (b * (b + 1) / 2);
        const text = "A grid has " + a + " squares across and " + b + " squares down. How many rectangles are there in total (including squares)?";
        const explanation = "Rectangles = (a(a+1)/2) x (b(b+1)/2) = (" + a + "*" + (a+1) + "/2) x (" + b + "*" + (b+1) + "/2) = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 12: {
        // Arrangements of 6 people in a row, but 2 must sit together
        const n = 6;
        // treat the pair as 1 block: 5! arrangements, pair can swap: x2
        const count = factorial(5) * 2;
        const text = "Six students sit in a row. Two specific students must sit next to each other. How many different seating orders are possible?";
        const explanation = "Treat the two students as one block: 5! ways. Inside the block there are 2 orders. Total: 5! x 2 = " + count + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 13: {
        // Password: 3 letters (29) then 2 digits, repetition allowed
        const count = Math.pow(29, 3) * Math.pow(10, 2);
        const text = "A code has 3 letters (Swedish alphabet, 29 letters) followed by 2 digits (0-9). Characters may repeat. How many codes are possible?";
        const explanation = "29^3 for letters and 10^2 for digits. Total: 29^3 x 10^2 = " + formatNumberWithSpaces(count) + ".";
        return { text, answerType: "integer", correctInteger: count, explanation };
      }
      case 14: {
        // Choosing without replacement probability: red then red
        const red = randInt(3, 8);
        const blue = randInt(2, 8);
        const total = red + blue;
        // P(R then R) = red/total * (red-1)/(total-1)
        const num = red * (red - 1);
        const den = total * (total - 1);
        const fr = simplifyFraction(num, den);
        const text = "A bag contains " + red + " red balls and " + blue + " blue balls. Two balls are drawn WITHOUT replacement. What is the probability that both are red?";
        const explanation = "First red: " + red + "/" + total + ". Then red again: " + (red - 1) + "/" + (total - 1) +
          ". Multiply: (" + red + "/" + total + ") x (" + (red - 1) + "/" + (total - 1) + ") = " + num + "/" + den +
          " = " + rationalToString(fr) + ".";
        return { text, answerType: "rational", correctRational: fr, explanation };
      }
      default:
        return genHardQuestion();
    }
  }

  function generateQuestionRaw(difficulty) {
    if (difficulty === "easy") return genEasyQuestion();
    if (difficulty === "medium") return genMediumQuestion();
    if (difficulty === "hard") return genHardQuestion();
    const choices = ["easy", "medium", "hard"];
    return generateQuestionRaw(choose(choices));
  }

  function generateQuestion(difficulty) {
    return generateNonRepeating(difficulty);
  }

  // ---------- State ----------

  let currentDifficulty = "easy";
  let currentQuestion = null;
  let awaitingNext = false;

  let totalAnswered = 0;
  let totalCorrect = 0;
  let score = 0;
  let streak = 0;
  let bestStreak = 0;

  let timerEnabled = false;
  let timerSeconds = 0;
  let timerRemaining = 0;
  let timerInterval = null;

  let soundEnabled = true;

  const incorrectLog = [];

  // ---------- Audio (simple beeps using Web Audio) ----------

  const audioCtx = (window.AudioContext || window.webkitAudioContext)
    ? new (window.AudioContext || window.webkitAudioContext)()
    : null;

  function playBeep(success) {
    if (!soundEnabled || !audioCtx) return;
    const duration = 0.12;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.value = success ? 880 : 220;
    gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  }

  // ---------- DOM helpers ----------

  const questionTextEl = document.getElementById("questionText");
  const answerInputEl = document.getElementById("answerInput");
  const submitBtn = document.getElementById("submitBtn");
  const nextBtn = document.getElementById("nextBtn");
  const feedbackArea = document.getElementById("feedbackArea");

  const diffButtons = Array.from(document.querySelectorAll(".diff-btn"));

  const timerSwitch = document.getElementById("timerSwitch");
  const soundSwitch = document.getElementById("soundSwitch");
  const timerSelect = document.getElementById("timerSelect");
  const timerDisplay = document.getElementById("timerDisplay");
  const resetSessionBtn = document.getElementById("resetSessionBtn");

  const statTotal = document.getElementById("statTotal");
  const statCorrect = document.getElementById("statCorrect");
  const statAccuracy = document.getElementById("statAccuracy");
  const statScore = document.getElementById("statScore");
  const statStreak = document.getElementById("statStreak");
  const statBestStreak = document.getElementById("statBestStreak");
  const summaryList = document.getElementById("summaryList");

  const gameCard = document.getElementById("gameCard");
  const worksheetCard = document.getElementById("worksheetCard");
  const modeGameBtn = document.getElementById("modeGameBtn");
  const modeWorksheetBtn = document.getElementById("modeWorksheetBtn");

  const wsDifficulty = document.getElementById("wsDifficulty");
  const wsCount = document.getElementById("wsCount");
  const generateWorksheetBtn = document.getElementById("generateWorksheetBtn");
  const worksheetList = document.getElementById("worksheetList");
  const revealAllBtn = document.getElementById("revealAllBtn");
  const hideAllBtn = document.getElementById("hideAllBtn");

  const devPanel = document.getElementById("devPanel");
  const devTestsContainer = document.getElementById("devTestsContainer");

  // ---------- Timer ----------

  function clearTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  function updateTimerDisplay() {
    if (!timerEnabled || timerSeconds === 0) {
      timerDisplay.textContent = "Timer off";
      timerDisplay.classList.remove("danger");
      return;
    }
    if (timerRemaining <= 0) {
      timerDisplay.textContent = "Time: 0 s";
      timerDisplay.classList.add("danger");
    } else {
      timerDisplay.textContent = "Time: " + timerRemaining + " s";
      timerDisplay.classList.toggle("danger", timerRemaining <= 5);
    }
  }

  function startTimer() {
    clearTimer();
    if (!timerEnabled || timerSeconds === 0) {
      timerDisplay.textContent = "Timer off";
      return;
    }
    timerRemaining = timerSeconds;
    updateTimerDisplay();
    timerInterval = setInterval(function() {
      timerRemaining -= 1;
      if (timerRemaining <= 0) {
        clearTimer();
        timerRemaining = 0;
        updateTimerDisplay();
        handleTimeOut();
      } else {
        updateTimerDisplay();
      }
    }, 1000);
  }

  function handleTimeOut() {
    if (!currentQuestion || awaitingNext) return;
    const message = "Time is up.";
    checkAnswerInternal(null, true, message);
  }

  // ---------- Stats & summary ----------

  function updateStats() {
    statTotal.textContent = totalAnswered;
    statCorrect.textContent = totalCorrect;
    const acc = totalAnswered === 0 ? 0 : Math.round((totalCorrect / totalAnswered) * 100);
    statAccuracy.textContent = acc + "%";
    statScore.textContent = score;
    statStreak.textContent = streak;
    statBestStreak.textContent = bestStreak;
  }

  function addIncorrectToSummary(entry) {
    incorrectLog.push(entry);
    const item = document.createElement("div");
    item.className = "summary-item";
    const qIndex = incorrectLog.length;

    const header = document.createElement("div");
    header.innerHTML = "<strong>#" + qIndex + ":</strong> " + entry.question;

    const yourAns = document.createElement("div");
    yourAns.textContent = "Your answer: " + (entry.yourAnswer === null ? "(no answer)" : entry.yourAnswer);

    const corrAns = document.createElement("div");
    corrAns.textContent = "Correct answer: " + entry.correctAnswer;

    item.appendChild(header);
    item.appendChild(yourAns);
    item.appendChild(corrAns);

    if (entry.extra) {
      const extra = document.createElement("div");
      extra.textContent = entry.extra;
      extra.style.color = "#9ca3af";
      item.appendChild(extra);
    }
    summaryList.appendChild(item);
  }

  function resetSession() {
    totalAnswered = 0;
    totalCorrect = 0;
    score = 0;
    streak = 0;
    bestStreak = 0;
    incorrectLog.length = 0;
    summaryList.innerHTML = "";
    updateStats();
    loadNewQuestion();
  }

  // ---------- Game logic ----------

  function setDifficulty(diff) {
    currentDifficulty = diff;
    diffButtons.forEach(btn => {
      btn.classList.toggle("active", btn.getAttribute("data-diff") === diff);
    });
    loadNewQuestion();
  }

  function renderQuestion() {
    if (!currentQuestion) return;
    questionTextEl.textContent = currentQuestion.text;
    feedbackArea.innerHTML = "";
    awaitingNext = false;
    submitBtn.disabled = false;
    nextBtn.disabled = false;
    answerInputEl.value = "";
    answerInputEl.focus();
    startTimer();
  }

  function loadNewQuestion() {
    currentQuestion = generateQuestion(currentDifficulty);
    renderQuestion();
  }

  function checkAnswerInternal(userInputRaw, fromTimer, timerMessage) {
    if (!currentQuestion) return;
    clearTimer();

    let correct = false;
    let userDisplayAnswer;
    let correctDisplay;
    let statusText;

    if (currentQuestion.answerType === "integer") {
      const parsed = parseIntegerInput(userInputRaw);
      if (parsed === null) correct = false;
      else correct = (parsed === currentQuestion.correctInteger);

      userDisplayAnswer = userInputRaw && userInputRaw.toString().trim() !== "" ? userInputRaw.trim() : "(no answer)";
      correctDisplay = formatNumberWithSpaces(currentQuestion.correctInteger);
    } else {
      const parsedFr = parseRationalInput(userInputRaw);
      const correctFr = currentQuestion.correctRational;
      correct = parsedFr && equalRationals(simplifyFraction(parsedFr.num, parsedFr.den), correctFr);

      userDisplayAnswer = userInputRaw && userInputRaw.toString().trim() !== "" ? userInputRaw.trim() : "(no answer)";
      correctDisplay = rationalToString(correctFr);
    }

    const feedbackStatus = document.createElement("div");
    feedbackStatus.className = "feedback-line";
    const statusSpan = document.createElement("span");
    statusSpan.className = "feedback-status " + (correct ? "correct" : "incorrect");
    if (correct) statusText = "Correct!";
    else statusText = fromTimer ? (timerMessage || "Incorrect (time).") : "Incorrect.";
    statusSpan.textContent = statusText;

    const answerSpan = document.createElement("span");
    answerSpan.textContent = "Correct answer: " + correctDisplay + ".";

    feedbackStatus.appendChild(statusSpan);
    feedbackStatus.appendChild(answerSpan);

    const explanationDiv = document.createElement("div");
    explanationDiv.className = "explanation";
    explanationDiv.textContent = currentQuestion.explanation;

    feedbackArea.innerHTML = "";
    feedbackArea.appendChild(feedbackStatus);

    const showStepsBtn = document.createElement("button");
    showStepsBtn.type = "button";
    showStepsBtn.className = "btn btn-secondary";
    showStepsBtn.style.marginTop = "0.25rem";
    showStepsBtn.textContent = "Show steps";

    const explWrapper = document.createElement("div");
    explWrapper.style.marginTop = "0.25rem";
    explWrapper.appendChild(explanationDiv);
    explWrapper.style.display = "none";

    showStepsBtn.addEventListener("click", function() {
      explWrapper.style.display = explWrapper.style.display === "none" ? "block" : "none";
    });

    feedbackArea.appendChild(showStepsBtn);
    feedbackArea.appendChild(explWrapper);

    if (correct) {
      playBeep(true);
      totalAnswered += 1;
      totalCorrect += 1;
      streak += 1;
      if (streak > bestStreak) bestStreak = streak;
      score += 10;
      if (streak > 0 && streak % 5 === 0) score += 5;
    } else {
      playBeep(false);
      totalAnswered += 1;
      streak = 0;
      addIncorrectToSummary({
        question: currentQuestion.text,
        yourAnswer: userDisplayAnswer,
        correctAnswer: correctDisplay,
        extra: fromTimer ? "Missed because of time." : null
      });
    }
    updateStats();
    awaitingNext = true;
    submitBtn.disabled = false;
  }

  function handleSubmit() {
    if (!currentQuestion) return;
    const value = answerInputEl.value;
    if (awaitingNext) {
      checkAnswerInternal(value, false);
      return;
    }
    checkAnswerInternal(value, false);
  }

  function handleNext() {
    loadNewQuestion();
  }

  // ---------- Worksheet mode ----------

  function renderWorksheet() {
    worksheetList.innerHTML = "";
    const diff = wsDifficulty.value;
    const count = parseInt(wsCount.value, 10) || 10;

    for (let i = 0; i < count; i++) {
      const actualDiff = diff === "random" ? choose(["easy","medium","hard"]) : diff;

      // For worksheet we also avoid repeats by using the same generator
      const q = generateNonRepeating(actualDiff);

      const item = document.createElement("div");
      item.className = "worksheet-item";

      const qDiv = document.createElement("div");
      qDiv.className = "worksheet-q";
      qDiv.textContent = (i + 1) + ". " + q.text;

      const ansDiv = document.createElement("div");
      ansDiv.className = "worksheet-answer hidden";

      let correctDisplay;
      if (q.answerType === "integer") correctDisplay = formatNumberWithSpaces(q.correctInteger);
      else correctDisplay = rationalToString(q.correctRational);

      ansDiv.textContent = "Answer: " + correctDisplay + ". Steps: " + q.explanation;

      const revealBtn = document.createElement("button");
      revealBtn.type = "button";
      revealBtn.className = "btn btn-secondary";
      revealBtn.style.marginTop = "0.2rem";
      revealBtn.textContent = "Reveal";

      revealBtn.addEventListener("click", function() {
        const hidden = ansDiv.classList.contains("hidden");
        ansDiv.classList.toggle("hidden", !hidden);
        revealBtn.textContent = hidden ? "Hide" : "Reveal";
      });

      item.appendChild(qDiv);
      item.appendChild(revealBtn);
      item.appendChild(ansDiv);
      worksheetList.appendChild(item);
    }
  }

  function revealAllWorksheet(show) {
    const answers = worksheetList.querySelectorAll(".worksheet-answer");
    const buttons = worksheetList.querySelectorAll(".worksheet-item .btn");
    answers.forEach(a => a.classList.toggle("hidden", !show));
    buttons.forEach(b => { b.textContent = show ? "Hide" : "Reveal"; });
  }

  // ---------- Mode switching ----------

  function setMode(mode) {
    if (mode === "game") {
      gameCard.style.display = "";
      worksheetCard.style.display = "none";
      modeGameBtn.classList.add("active");
      modeWorksheetBtn.classList.remove("active");
      answerInputEl.focus();
    } else {
      gameCard.style.display = "none";
      worksheetCard.style.display = "";
      modeGameBtn.classList.remove("active");
      modeWorksheetBtn.classList.add("active");
      revealAllWorksheet(false);
    }
  }

  // ---------- Switch toggles ----------

  function toggleSwitch(el) {
    const on = !el.classList.contains("on");
    el.classList.toggle("on", on);
    el.setAttribute("aria-checked", on ? "true" : "false");
    return on;
  }

  timerSwitch.addEventListener("click", function() {
    timerEnabled = toggleSwitch(timerSwitch);
    if (!timerEnabled) {
      clearTimer();
      updateTimerDisplay();
    } else {
      timerSeconds = parseInt(timerSelect.value, 10) || 0;
      startTimer();
    }
  });

  timerSwitch.addEventListener("keydown", function(e) {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      timerSwitch.click();
    }
  });

  soundSwitch.addEventListener("click", function() {
    soundEnabled = toggleSwitch(soundSwitch);
  });

  soundSwitch.addEventListener("keydown", function(e) {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      soundSwitch.click();
    }
  });

  timerSelect.addEventListener("change", function() {
    const v = parseInt(timerSelect.value, 10) || 0;
    timerSeconds = v;
    if (!timerEnabled || v === 0) {
      clearTimer();
      updateTimerDisplay();
    } else {
      startTimer();
    }
  });

  resetSessionBtn.addEventListener("click", function() {
    resetSession();
  });

  // ---------- Event listeners ----------

  diffButtons.forEach(btn => {
    btn.addEventListener("click", function() {
      const diff = btn.getAttribute("data-diff");
      setDifficulty(diff);
    });
  });

  submitBtn.addEventListener("click", function() { handleSubmit(); });
  nextBtn.addEventListener("click", function() { handleNext(); });

  answerInputEl.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      if (awaitingNext) handleNext();
      else handleSubmit();
    } else if (e.key === "Escape") {
      e.preventDefault();
      answerInputEl.value = "";
    }
  });

  modeGameBtn.addEventListener("click", function() { setMode("game"); });
  modeWorksheetBtn.addEventListener("click", function() { setMode("worksheet"); });

  generateWorksheetBtn.addEventListener("click", function() { renderWorksheet(); });
  revealAllBtn.addEventListener("click", function() { revealAllWorksheet(true); });
  hideAllBtn.addEventListener("click", function() { revealAllWorksheet(false); });

  // ---------- Developer tests (kept) ----------

  function runDevTests() {
    const tests = [];

    tests.push({
      name: "3 digits, 2-digit numbers without repetition",
      run: function() { return (3 * 2) === 6; }
    });

    tests.push({
      name: "{4,6,8} 2-digit numbers with repetition",
      run: function() { return (3 * 3) === 9; }
    });

    tests.push({
      name: "4 shirts, 3 jeans",
      run: function() { return 4 * 3 === 12; }
    });

    tests.push({
      name: "3x4x2 meal combinations",
      run: function() { return 3 * 4 * 2 === 24; }
    });

    tests.push({
      name: "4-digit code 0-9 with repetition",
      run: function() { return Math.pow(10,4) === 10000; }
    });

    tests.push({
      name: "Permutations of 4 distinct digits",
      run: function() { return factorial(4) === 24; }
    });

    tests.push({
      name: "Permutations of 5 distinct digits",
      run: function() { return factorial(5) === 120; }
    });

    tests.push({
      name: "Combinations C(6,2)",
      run: function() { return combinations(6,2) === 15; }
    });

    tests.push({
      name: "Probability red (4 red, 3 green, 3 other) = 2/5",
      run: function() {
        const fr = simplifyFraction(4, 10);
        return fr.num === 2 && fr.den === 5;
      }
    });

    tests.push({
      name: "Handshakes n=10",
      run: function() { return 10 * 9 / 2 === 45; }
    });

    tests.push({
      name: "Licence plates 29^3 x 10^3",
      run: function() {
        const value = Math.pow(29,3) * Math.pow(10,3);
        return value === 24389 * 1000;
      }
    });

    devTestsContainer.innerHTML = "";
    tests.forEach(function(t, idx) {
      let passed = false;
      try { passed = !!t.run(); } catch (e) { passed = false; }
      const row = document.createElement("div");
      row.className = "dev-test";
      const nameSpan = document.createElement("span");
      nameSpan.textContent = (idx + 1) + ". " + t.name;
      const statusSpan = document.createElement("span");
      statusSpan.textContent = passed ? "PASS" : "FAIL";
      statusSpan.className = passed ? "status-pass" : "status-fail";
      row.appendChild(nameSpan);
      row.appendChild(statusSpan);
      devTestsContainer.appendChild(row);
    });
  }

  function initDevModeIfNeeded() {
    if (location.search.toLowerCase().includes("dev=1")) {
      devPanel.style.display = "";
      runDevTests();
    }
  }

  // ---------- Init ----------

  function init() {
    timerEnabled = false;
    timerSeconds = parseInt(timerSelect.value, 10) || 0;
    updateTimerDisplay();
    setDifficulty("easy");
    setMode("game");
    updateStats();
    initDevModeIfNeeded();
  }

  init();
})();
</script>
</body>
</html>
